---
title: "Tejon_Analysis_02162021"
author: "sbsambado"
date: "2/16/2021"
output: html_document
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readr)
library(ggpubr)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(plyr)
library(car)
library(multcomp)
library(multcompView)
library(reshape2)
library(stringr)
library(car)
library(psych)
library(knitr)
library(nlme)
library(lme4)
library(kableExtra)
library(MASS)
library(grid)
library(vegan)
library(devtools)
library(ggfortify)
library(jtools)
library(effects)
library(pscl)
library(lmtest)
library(ggstance)
library(huxtable)
library(qwraps2)
library(gtsummary)
library(Rcapture)
library(xlsx)
library(glmmTMB) # to get the Salamanders dataset
library(tidyverse) # to make your life easier
library(gt) # to render a table
library(patchwork) # to put plots together
library(effects) #install.packages("effects")
library(jtools)

devtools::install_github('gavinsimpson/ggvegan')


clean_background <- theme(plot.background = element_rect("white"),
        panel.background = element_rect("white"),
        panel.grid = element_line("white"),
        axis.line = element_line("gray25"),
        axis.text = element_text(size = 12, color = "gray25"),
        axis.title = element_text(color = "gray25"),
        legend.text = element_text(size = 12),
        legend.key = element_rect("white"))

plotcolor = c('darkseagreen1','darkseagreen3','darkseagreen4')
sitecolor = c('brown1','tan1','lightgoldenrod1')

rotatexaxistheme <- theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))
ytitletheme <- theme(axis.title.y = element_text(face = 'bold', size = 12, vjust = 0.5))
xtitletheme <- theme(axis.title.x = element_text(face = 'bold', size = 12, vjust = 0.5))
```

## Dataset for means of ticks
Using data Steph sent on 11/16/2020
"Total_Ticks_2016_to_2018.csv"
"Tick_19.csv"

Merge 2 tick data sheets into 1 tick data sheet
```{r message = FALSE}

threeyrs <- read_csv("Total_Ticks_2016_to_2018.csv")
dim(threeyrs)
oneyr <- read_csv("Tick_19.csv")
dim(oneyr)
# get rid of survery column in threeyr since it wasn't completed in oneyrs 
## Maybe double check survey number doesn't matter
threeyrs <- subset(threeyrs, select = -c(3))

# make sure names are the same
## 2016 - 2018
names(threeyrs) <- tolower(names(threeyrs))

# change column names
names(threeyrs)[6] <- "total"
names(threeyrs)[7] <- "deoc"
names(threeyrs)[8] <- "ipac"
names(threeyrs)[9] <- "deva"
names(threeyrs)[10] <- "other"

## 2019
# make sure names are the same
names(oneyr) <- tolower(names(oneyr))

# change column names
names(oneyr)[6] <- "total"
names(oneyr)[7] <- "deoc"
names(oneyr)[8] <- "ipac"
names(oneyr)[9] <- "deva"
names(oneyr)[10] <- "other"


tick <- rbind(threeyrs, oneyr)

# log transform data
tick$log_total <- log(tick$total + 1)

## FINAL DATASET TO COMPARE TICK MEANS
dim(tick) # 1449 11
str(tick)

tick$year <- as.numeric(tick$year)
tick$site <- as.factor(tick$site)
tick$plot <- as.factor(tick$plot)
Tick <- tick
```

Basic stats
```{r warning = FALSE}

(plotcount <- Tick %>% 
  group_by(plot) %>% 
  tally(total) )# open = 488, partial = 976, total = 1228

(sitecount <- Tick %>% 
  group_by(site) %>% 
  tally(total)) # arid = 340, intermediate = 1764, mesic = 588

(Tickcount <- Tick %>% 
  group_by(site, plot) %>% 
  tally(total))

(tickmodels <-kable(Tickcount, digits = 2, align = 'c') %>%
    pack_rows(
      index = c("Arid" = 3, "Intermediate" = 3, "Mesic" = 3)
    ))

Plot <- c('Open','Partial', 'Total',
          'Open','Partial', 'Total',
          'Open','Partial', 'Total')
n <- c('21', '195','124', '364', '554', '846', '103', '227', '258')

summm <- data.frame(Plot,n)

(suuuuuum <- kable(summm,digits = 2, align = 'c', booktabs = TRUE, caption = "Site") %>%
    pack_rows(
      index = c("Arid" = 3, "Intermediate" = 3, "Mesic" = 3)
    ) %>%
    kable_styling() %>%
  kable_paper() %>%
  save_kable(file = "table1.html", self_contained = T)
)
```

## Tick Means Analyses

#### **1. wilcox rank test for treatment vs control [medians total ticks]**
Plot (open vs total): W = 90379, p-value = 5.649e-07
```{r wilcox rank test}

site_subset <- Tick[which(Tick$site == "Arid" | Tick$site == "Mesic"),]
plot_subset <- Tick[which(Tick$plot == "Open" | Tick$plot == "Total"),]
leveneTest(site_subset$log_total ~ site_subset$site) # df 1, F value = 21.401, p = 4.263e-06, < 0.05, variances are different
leveneTest(plot_subset$log_total ~ plot_subset$plot) # df 1, F value = 34.118, p = 7.171e-09, < 0.05, variances are different


## wilcox (non-equal variances)

wilcox.test(log_total ~ site, data = site_subset) # W = 91628, p-value = 4.898e-05
wilcox.test(log_total ~ plot, data = plot_subset) # W = 90379, p-value = 5.649e-07
```
  
#### **2. TWO WAY ANOVA [log means of total ticks]**
Plot: 3 levels, within-subjects factor? (F value = 20.298, df = 2, p= 2.05e-09)
Site: 3 levels, within-subjects factor?  (F value = 61.154, df = 2,  p < 2e-16)
plot*site interaction (F value = 0.847, df = 4, p = 0.496)

**Post-hoc Test: Tukey Kramer**
**Site**
  Arid (a)
  Intermediate (b)
  Mesic (c )
**Plot**
  Open (a)
  Partial (b)
  Total (b)

```{r two-way anova}
# log transform data
Tick$log_total <- log(Tick$total + 1)
# look at data
boxplot(log_total ~ site, data = Tick)
boxplot(log_total ~ plot, data = Tick)

# two way anova with log values and interaction value
aov_Tick <- aov(log_total ~ plot + site + (plot*site), data = Tick)
summary(aov_Tick)

# check assumptions on residuals
plot(aov_Tick) # both residual and qqPlot look normal

# check residuals
qqPlot(aov_Tick$residuals) # kinda looks normally distributed, but not perfect
shapiro.test(aov_Tick$residuals) # p < 0.05, data not normal but
dim(Tick) # 1449 CTL applies

## Proceed with post-hoc test
TukeyHSD(aov_Tick)
# SITE
Post_hoc_site <-glht(aov_Tick, linfct = mcp(site = 'Tukey'))
summary(Post_hoc_site)

confint(Post_hoc_site) # pairwise test
cld(Post_hoc_site) # arid = a, intermediate = b, mesic = c
plot(Post_hoc_site) # plot 95% CIs

# PLOT
Post_hoc_plot <-glht(aov_Tick, linfct = mcp(plot = 'Tukey'))
summary(Post_hoc_plot)

confint(Post_hoc_plot) # pairwise test
cld(Post_hoc_plot) # open = a, partial = b, total = b
plot(Post_hoc_plot) # plot 95% CIs
```


## Dataset for linear models

Lots of movin' and groovin here. Trying to add multiple datasets together while avoiding duplication and too much observation lost
```{r message=FALSE}
##################################################################################################
# TICK COUNTS (YEAR, MONTH, PLOT, SITE)
#################################################################################################

# use cleaned up version that was used for mean tick count analyses = Tick
dim(Tick) # 1449 observations, 11 rows


##################################################################################################
# CLIMATE (TEMP, PRECIP)
#################################################################################################

############## temperature ##############
temp <- read_csv("Tejon_temperature_02022021.csv")
temp.tick <- merge(Tick, temp)
dim(temp.tick) # 1449, 14 (added meanmaxF, meanminF, station)
#View(temp.tick)

############## precipitation ##############

precip <- read_csv("tejon_tick_climate_10162020.csv")

precip_subset <- subset(precip, select = c(1:5,19,20))
names(precip_subset) <- tolower(names(precip_subset))
temp.tick.precip <- join(temp.tick, precip_subset)
dim(temp.tick.precip) #2025, 16 (added precip (in), precip (mm))
names(temp.tick.precip)
# seems like data got duplicated let's fix that

# best way is to remove duplicate rows which I lose ~50 observations but I think that is a better way to do it then extract unique elements by columns since alot of these observations are repetitive

temp.tick.prep.short <- temp.tick.precip %>%
  distinct()

dim(temp.tick.prep.short) # 1395, 16

##################################################################################################
# VERTEBRATE (SPIECES RICHNESS, DIVERSITY, POP ESTIMATES)
#################################################################################################

############## mammal metrics ############## 

mam <- read_csv("tejon_mammal_02022021.csv")
names(mam) <- tolower(names(mam))

climate.mam <- join(temp.tick.prep.short, mam)
dim(climate.mam) # 1895, 19 (added cum_mammal, shan_mammal, rich_mammal)

# remove duplicate rows

climate.mam.short <- climate.mam %>%
  distinct()
dim(climate.mam.short) #1395, 19 # same amount of observations after climate dataset


############## pop estimates ############## 

pop_estimates <-read_csv("tejon_mamliz_popestimates.csv")
dim(pop_estimates) #27 5

climate.mam.combo <- join(climate.mam.short, pop_estimates)
dim(climate.mam.combo) # 1395   21 (added liz estimates, mam estimates)

dim(climate.mam.combo) # 1395   21
names(climate.mam.combo)

```



```{r tidy data}
# let's shape this final sheet

## add some more metadata
# add Celcius
climate.mam.combo$mean_maxC <- (climate.mam.combo$mean_maxF - 32)*(5/9)
climate.mam.combo$mean_minC <- (climate.mam.combo$mean_minF - 32)*(5/9)


# add temperature difference 
climate.mam.combo$tempdifF <- (climate.mam.combo$mean_maxF - climate.mam.combo$mean_minF)
climate.mam.combo$tempdifC <- (climate.mam.combo$mean_maxC - climate.mam.combo$mean_minC)



# add elevation
  climate.mam.combo$elevation <- climate.mam.combo$station
  climate.mam.combo$elevation[climate.mam.combo$station == "Lebec"] <- 1089.7
  climate.mam.combo$elevation[climate.mam.combo$station == "Loraine"] <- 1290.8
  climate.mam.combo$elevation[climate.mam.combo$station == "Chuchupate"] <- 1493.5

# add rain year
  # this is a dumb way but it is what it is
  climate.mam.combo$rain_year <- as.numeric(climate.mam.combo$year)
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'April'] <- "2015/2016"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'May'] <- "2015/2016"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'June'] <- "2015/2016"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'July'] <- "2015/2016"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'August'] <- "2015/2016"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'September'] <- "2015/2016"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'October'] <- "2015/2016"
  
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'November'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'December'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'January'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'February'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'March'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'April'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'May'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'June'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'July'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'August'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'September'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'October'] <- "2016/2017"
  
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'November'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'December'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'January'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'February'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'March'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'April'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'May'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'June'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'July'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'August'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'September'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'October'] <- "2017/2018"
  
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'November'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'December'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'January'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'February'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'March'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'April'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'May'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'June'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'July'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'August'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'September'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'October'] <- "2018/2019"
  
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'November'] <- "2019/2020"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'December'] <- "2019/2020"

# add plotID
climate.mam.combo <- transform(climate.mam.combo, plotidname = as.character(interaction(site, plot,block, drop = TRUE)))
climate.mam.combo <- transform(climate.mam.combo, plotID = as.numeric(interaction(site, plot,block, drop = TRUE)))
str(climate.mam.combo) # 1395 observations, 26 variables (added plotidname, plotID)

# put data in right format
str(climate.mam.combo)

climate.mam.combo$year <- as.factor(climate.mam.combo$year)
climate.mam.combo$block <- as.factor(climate.mam.combo$block)
climate.mam.combo$plotID <- as.factor(climate.mam.combo$plotID)
climate.mam.combo$rain_year <- as.factor(climate.mam.combo$rain_year)
climate.mam.combo$elevation <- as.numeric(climate.mam.combo$elevation)

climate.mam.combo$month <- factor(climate.mam.combo$month, 
                        levels = c('January', 'February', 'March',
                                   'April', 'May', 'June', 'July',
                                   'August', 'September', 'October',
                                   'November', 'December'))
climate.mam.combo$site <- factor(climate.mam.combo$site, 
                    levels = c('Arid', 'Intermediate', 'Mesic'))

climate.mam.combo$plot <- factor(climate.mam.combo$plot, 
                    levels = c('Open', 'Partial', 'Total'))

# rename precip columns
names(climate.mam.combo)[15] <- "precip_in"
names(climate.mam.combo)[16] <- "precip_mm"


# Finally, the final dataset for GLMMS
FINAL <- climate.mam.combo
str(FINAL) # 1395 observations, 30 variables

# write to an excel sheet
write.xlsx(FINAL, file = "Tejon_MixedModels_Dataset.xlsx",
           col.names = TRUE, row.names = TRUE)
```

GLMs
```{r warning = FALSE}
boxplot(log_total ~ site, data = FINAL)
boxplot(log_total ~ plot, data = FINAL)

tab <- xtabs(~log_total, data = FINAL)
x <- as.numeric(names(tab))
plot(x, tab, type = "h")
points(x, tab, pch = 16)

mod.counts <- glm(log_total ~ site + plot,
                  family = poisson, data = FINAL)
summary(mod.counts)

plot(predictorEffects(mod.counts))


```




# GLMs
### just two factors of interest: site and plot
```{r warning = FALSE}

glm.negbin1 = glm(log_total ~ site, data = FINAL, family = "poisson")
summary(glm.negbin1)

glm.negbin2 = glm(log_total ~ plot, data = FINAL, family = "poisson")
summary(glm.negbin2)

```

# Negative binomial GLMS
```{r warnings =FALSE, message=FALSE}
final.plot <- subset(FINAL, select = c(11:21))
pairs.panels(final.plot) # makes sense that min-max, cum-shan, cum-rich are highly correlated, keep this in mind when building models

## random effects models

# tick counts ~ climate + host, random = ~1|plotID + ~1|rain year
```

**Climate models**
*Best model*
gnb_mod3 <- glmer.nb(total ~ tempdifC + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")
```{r climate models, warnings =FALSE, message=FALSE}
######################## CLIMATE MODELS ########################
###### mean_maxF, mean_minF, tempdifF, mean_maxC, mean_minC, tempdifC, precip_in, precip_mm ####


str(FINAL)
climate_gnbmod1 <- glmer.nb(total ~ mean_maxC + (1|plotID) + (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")


climate_gnbmod2 <- glmer.nb(total ~ mean_minC + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

climate_gnbmod3 <- glmer.nb(total ~ tempdifC + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

climate_gnbmod4 <- glmer.nb(total ~ precip_mm + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

climate_gnbmod5 <- glmer.nb(total ~ mean_maxC + mean_minC + tempdifC +precip_mm + 
                       (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

result <- AIC(climate_gnbmod1, climate_gnbmod2, climate_gnbmod3,climate_gnbmod4,climate_gnbmod5)
models <- list(climate_gnbmod1, climate_gnbmod2, climate_gnbmod3,climate_gnbmod4,climate_gnbmod5)



result$BIC <- sapply(models, BIC)
model_summary <- lapply(models, summary)
for(i in 1:(length(models)-1)){ #this creates a variable i that starts with the value i=1
  result$rsq[i] <- model_summary[[i]]$r.squared #we assign the rsq value from model i to the i'th row of the column 'rsq' in the table 'results'
  result$adj_rsq[i] <- model_summary[[i]]$adj.r.squared #same for adjusted rsq
} #now we go back to the beginning of the for-loop, add 1 to the value of i, and do everything again

result$variables <- c("maxC", "minC", "tempdiffC", "precip_mm", "Full")

climate_models <- kable(result, digits = 2, align = "c") %>%
  kable_styling()

### best fit model is gnb.mod3...difference in C based on BIC

```


**Host models**
*Best model*
gnb_mod4 <- glmer.nb(total ~ liz_estimate + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")
```{r host models, warnings =FALSE, message=FALSE}
######################## HOST MODELS ########################
###### cum_mammal shan_mammal rich_mammal liz_estimates mam_estimates ####


str(FINAL)
host_gnb_mod1 <- glmer.nb(total ~ cum_mammal + (1|plotID) + (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")


host_gnb_mod2 <- glmer.nb(total ~ shan_mammal + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

host_gnb_mod3 <- glmer.nb(total ~ rich_mammal + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

host_gnb_mod4 <- glmer.nb(total ~ liz_estimate + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

host_gnb_mod5 <- glmer.nb(total ~ mam_estimates + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

# there's collinearity in full
host_gnb_mod6 <- glmer.nb(total ~ shan_mammal + rich_mammal + liz_estimate + mam_estimates + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

# less collinearity in partial
#host_gnb_mod7 <- glmer.nb(total ~ cum_mammal + shan_mammal + rich_mammal + liz_estimates + mam_estimates + (1|plotID)+ (1|rain_year) + (1|month), data = na.omit(FINAL),family = "poisson")

result <- AIC(host_gnb_mod1, host_gnb_mod2, host_gnb_mod3,host_gnb_mod4,host_gnb_mod5,host_gnb_mod6)
models <- list(host_gnb_mod1, host_gnb_mod2, host_gnb_mod3,host_gnb_mod4,host_gnb_mod5,host_gnb_mod6)



result$BIC <- sapply(models, BIC)
model_summary <- lapply(models, summary)
for(i in 1:(length(models)-1)){ #this creates a variable i that starts with the value i=1
  result$rsq[i] <- model_summary[[i]]$r.squared #we assign the rsq value from model i to the i'th row of the column 'rsq' in the table 'results'
  result$adj_rsq[i] <- model_summary[[i]]$adj.r.squared #same for adjusted rsq
} #now we go back to the beginning of the for-loop, add 1 to the value of i, and do everything again

result$variables <- c("cum_mam", "shan_mam", "rich_mam", "liz_estimates", "mam_estimates", "Full")

host_models <- kable(result, digits = 2, align = "c") %>%
  kable_styling()

### best fit model is gnb.mod4... liz estimates based on BIC


## see if it can predict model
# splitter <- sample(1:nrow(FINAL), 10, replace = F)
# final_train <- na.omit(FINAL[-splitter,])
# final_test <- na.omit(FINAL[splitter,])
# 
# final_fit <- glmer.nb(total ~ tempdifC + (1|plotID)+ (1|rain_year) + (1|month), 
#                  data = na.omit(FINAL),
#                  family = "poisson")
# 
# prediction <- predict(final_fit, final_test)
# 
# plot(final_test$total, pch = 1)
# points(prediction, pch = 20, col = "red")
```

**Combination models**
*Best fit*
BIC = 907.06
gnb_mod5 <- glmer.nb(total ~ tempdifC*site + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")
BIC = 908.18                
gnb_mod3 <- glmer.nb(total ~ tempdifC + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

                 
                 
```{r combo models, warnings =FALSE, message=FALSE}

# plot predictor
combo_gnb_mod1 <- glmer.nb(total ~ plot + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

# site predictor
combo_gnb_mod2 <- glmer.nb(total ~ site + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

# best climate predictor
combo_gnb_mod3 <- glmer.nb(total ~ tempdifC + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")
# best host predictor
combo_gnb_mod4 <- glmer.nb(total ~ liz_estimate + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

# interaction models
combo_gnb_mod5 <- glmer.nb(total ~ tempdifC*site + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

combo_gnb_mod6 <- glmer.nb(total ~ liz_estimate*plot + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")


# full
combo_gnb_mod7 <- glmer.nb(total ~ plot + site + tempdifC + liz_estimate + tempdifC*site + liz_estimate*plot + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

result <- AIC(combo_gnb_mod1, combo_gnb_mod2, combo_gnb_mod3,combo_gnb_mod4,combo_gnb_mod5,combo_gnb_mod6)
models <- list(combo_gnb_mod1, combo_gnb_mod2, combo_gnb_mod3,combo_gnb_mod4,combo_gnb_mod5,combo_gnb_mod6)



result$BIC <- sapply(models, BIC)
model_summary <- lapply(models, summary)
for(i in 1:(length(models)-1)){ #this creates a variable i that starts with the value i=1
  result$rsq[i] <- model_summary[[i]]$r.squared #we assign the rsq value from model i to the i'th row of the column 'rsq' in the table 'results'
  result$adj_rsq[i] <- model_summary[[i]]$adj.r.squared #same for adjusted rsq
} #now we go back to the beginning of the for-loop, add 1 to the value of i, and do everything again

result$variables <- c("plot", "site", "tempdifC", "liz_estimate", "tempdifC*site", "liz_estimate*plot")

combo_models <- kable(result, digits = 2, align = "c") %>%
  kable_styling()


## best fit model is interaction1 (liz estimates*plot) BIC = 907.06
## next best one is temp BIC = 908.18
```

```{r}
climate_models
host_models
combo_models
```


Check model assumption
https://stats.idre.ucla.edu/r/dae/negative-binomial-regression/

```{r}

# check residuals
plot(gnb_mod3)

# best model based on parsimony is 
m1 <- glmer.nb(total ~ tempdifC + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")
# Neg binomial models assume the conditional means are not equal to the conditional variances. This inequality is captured by estimating a dispersion parater that is held constant in a poisson model. The poisson model is actually nested int he negative binomial mode. We can use likelihood ratio test to compare thes two and test the model assumption

# compare model without tempdifC to see if it is significantly different
m2 <- update(gnb_mod3, . ~ . - tempdifC)
anova(m1, m2) # 2.716e-05, tempdiffC is a singificant predictor of total 

# check model assumptions
m3 <- glm(total ~ tempdifC + site, family = "poisson", data = FINAL)
pchisq(2 * (logLik(m1) - logLik(m3)), df = 1, lower.tail = FALSE)

(est <- cbind(Estimate = coef(m1), confint(m1)))
exp(est)
```

Predicted values
```{r}

## see if it can predict model
splitter <- sample(1:nrow(FINAL), 70, replace = F)
final_train <- na.omit(FINAL[-splitter,])
final_test <- na.omit(FINAL[splitter,])

final_fit <- glmer.nb(total ~ tempdifC + (1|plotID)+ (1|rain_year) + (1|month),
                 data = na.omit(FINAL),
                 family = "poisson")

prediction <- predict(final_fit, final_test)

plot(final_test$total, pch = 1)
points(prediction, pch = 20, col = "red")

```


Another model validation
The best(top) model state that liz_estimates and tempdifC are important
```{r}

min(FINAL$total)
model <- na.omit(FINAL)
big.model <- glm(total  ~ plot + site  + tempdifC + liz_estimate, 
                 family = "poisson",
                 data = model,
                 na.action = na.pass)
library(MuMIn)
library(gtable)
sal.dredge <- dredge(big.model)

glm.best <-model.sel(sal.dredge) %>% 
  gt() %>% 
  tab_header(title="all model subsets",
             subtitle = "total ~ plot + site + tempdifC + liz_estimates")
gtsave(glm.best, "DredgeModel_BestPredictors.html")

```

### Additional Analyses that were used to make input variables for glmms

#### Population estimates for lizards and mammals

*Original datasets I was given: `Lizard_Counts_TREE` for lizards and `2018_smammals` and `Small_mammal_captures_19`* 

From those, I created an excel sheet called `tejon_mamliz_popestimates` that I made based on the analyses in lizard estimates and mammal estimates. Yes, I know this could have been done with a for loop but couldn't get my brain to think about it. This excel sheet is used to build the full data sheet with climate and tick counts

```{r data sheets for pop estimates}
# Used these data sheets to calculate pop estimates. All calculations used to make population estimates can be found in the dataset `tejon_mamliz_popestimates`.
### mammals 
mamcounts <- read_csv("mammal_counts_02182021.csv")
dim(mamcounts) # 229   9

str(mamcounts)
mamcounts$day1 <- as.numeric(mamcounts$day1)
mamcounts$day2 <- as.numeric(mamcounts$day2)
mamcounts$day3 <- as.numeric(mamcounts$day3)
mamcounts$site <- as.factor(mamcounts$site)
mamcounts$plot <- as.factor(mamcounts$plot)
mamcounts$block <- as.numeric(mamcounts$block)
str(mamcounts)

### lizards
lizcounts <- read_csv("lizardcounts_02172021.csv")
dim(lizcounts) # 1745 , 10
names(lizcounts) <- tolower(names(lizcounts))

str(lizcounts)
lizcounts$day1 <- as.numeric(lizcounts$day1)
lizcounts$day2 <- as.numeric(lizcounts$day2)
lizcounts$day3 <- as.numeric(lizcounts$day3)
lizcounts$site <- as.factor(lizcounts$site)
lizcounts$plot <- as.factor(lizcounts$plot)
lizcounts$block <- as.numeric(lizcounts$block)
str(lizcounts)

```

```{r lizard estimates}
AridO <- lizcounts %>%
  filter(site == "Arid", plot =="Open", block == 1) %>%
  select(day1, day2, day3)
  
abundance0 = closedp.t(AridO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundance0$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

# ARID OPEN BLOCK 1 = 51.35882

AridO <- lizcounts %>%
  filter(site == "Arid", plot =="Open", block == 2) %>%
  select(day1, day2, day3)
  
abundance0 = closedp.t(AridO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundance0$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

# ARID OPEN BLOCK 2 = 60.5687

AridO <- lizcounts %>%
  filter(site == "Arid", plot =="Open", block == 3) %>%
  select(day1, day2, day3)
  
abundance0 = closedp.t(AridO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundance0$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

# ARID OPEN BLOCK 3 = 82.54301



##########################################################################
AridP <- lizcounts %>%
  filter(site == "Arid", plot =="Partial", block == 1) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(AridP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID PARTIAL Block 1 = 73.4186

AridP <- lizcounts %>%
  filter(site == "Arid", plot =="Partial", block == 2) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(AridP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID PARTIAL Block 2 = 72.96941

AridP <- lizcounts %>%
  filter(site == "Arid", plot =="Partial", block == 3) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(AridP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID PARTIAL Block 3 = 69.2156


##########################################################################

AridT <- lizcounts %>%
  filter(site == "Arid", plot =="Total", block == 1) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(AridT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID TOTALBLOCK 1 = 67.28581

AridT <- lizcounts %>%
  filter(site == "Arid", plot =="Total", block == 2) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(AridT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID TOTALBLOCK 2 = 60.0097

AridT <- lizcounts %>%
  filter(site == "Arid", plot =="Total", block == 3) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(AridT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID TOTALBLOCK 3 = 88.44651


##############################################################################
##############################################################################
##############################################################################


IntermediateO <- lizcounts %>%
  filter(site == "Intermediate", plot =="Open", block == 1) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(IntermediateO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate OPEN BlOCK 1 = 129.3622

IntermediateO <- lizcounts %>%
  filter(site == "Intermediate", plot =="Open", block == 2) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(IntermediateO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate OPEN BlOCK 2 = 84.6362

IntermediateO <- lizcounts %>%
  filter(site == "Intermediate", plot =="Open", block == 3) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(IntermediateO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate OPEN BlOCK 3 = 207.9784

##########################################################################
IntermediateP <- lizcounts %>%
  filter(site == "Intermediate", plot =="Partial", block == 1) %>%
  select(day1, day2, day3) %>%
  na.omit(lizardcounts)
  
abundanceP = closedp.t(IntermediateP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate PARTIAL BLOCK 1 = 133.5039

IntermediateP <- lizcounts %>%
  filter(site == "Intermediate", plot =="Partial", block == 2) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(IntermediateP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate PARTIAL BLOCK 2 = 47.43047

IntermediateP <- lizcounts %>%
  filter(site == "Intermediate", plot =="Partial", block == 3) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(IntermediateP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate PARTIAL BLOCK 3 = 162.613

##########################################################################

IntermediateT <- lizcounts %>%
  filter(site == "Intermediate", plot =="Total", block == 1) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(IntermediateT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance , lowest BIC had negative value with Mbh so I chose next best model Mb abundance = 137.9494

## Intermediate TOTAL BLOCK 1 = 398.0468

IntermediateT <- lizcounts %>%
  filter(site == "Intermediate", plot =="Total", block == 2) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(IntermediateT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate TOTAL BLOCK 2 = 84.5119

IntermediateT <- lizcounts %>%
  filter(site == "Intermediate", plot =="Total", block == 3) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(IntermediateT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate TOTAL BLOCK 3 = 176.55


```

```{r mammal estimates }
AridO <- mamcounts %>%
  filter(site == "Arid", plot =="Open", block == 1) %>%
  select(day1, day2, day3)
  
abundance0 = closedp.t(AridO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundance0$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID OPEN Block 1 = 2

AridO <- mamcounts %>%
  filter(site == "Arid", plot =="Open", block == 2) %>%
  select(day1, day2, day3)
  
abundance0 = closedp.t(AridO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundance0$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID OPEN Block 2 = 5.236068

AridO <- mamcounts %>%
  filter(site == "Arid", plot =="Open", block == 3) %>%
  select(day1, day2, day3)
  
abundance0 = closedp.t(AridO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundance0$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID OPEN Block 3 = 2.618034

##########################################################################
AridP <- mamcounts %>%
  filter(site == "Arid", plot =="Partial", block == 1) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(AridP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID PARTIAL BLOCK 1= 15.51451
AridP <- mamcounts %>%
  filter(site == "Arid", plot =="Partial", block == 2) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(AridP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance , lowest BIC was negative so chose next lowest model M0

## ARID PARTIAL BLOCK 2= 45.38767
AridP <- mamcounts %>%
  filter(site == "Arid", plot =="Partial", block == 3) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(AridP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID PARTIAL BLOCK 3= estimates were in the 500000000 so I chose to omit this block 

##########################################################################

AridT <- mamcounts %>%
  filter(site == "Arid", plot =="Total", block == 1) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(AridT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID TOTAL block 1= 15.51451

AridT <- mamcounts %>%
  filter(site == "Arid", plot =="Total", block == 2) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(AridT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID TOTAL block 2= 40.80791

AridT <- mamcounts %>%
  filter(site == "Arid", plot =="Total", block == 3) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(AridT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID TOTAL block 3= 15.51451


##############################################################################
##############################################################################
##############################################################################

# no mammals trapped at block 1 intermediate open

IntermediateO <- mamcounts %>%
  filter(site == "Intermediate", plot =="Open", block == 2) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(IntermediateO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate OPEN BLOCK 2 = 5.236068

IntermediateO <- mamcounts %>%
  filter(site == "Intermediate", plot =="Open", block == 3) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(IntermediateO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate OPEN BLOCK 3 = estimates were in the 7e09 so I chose to omit this block 


##########################################################################
IntermediateP <- mamcounts %>%
  filter(site == "Intermediate", plot =="Partial", block == 1) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(IntermediateP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate PARTIAL BLOCK 1= 7.734787

IntermediateP <- mamcounts %>%
  filter(site == "Intermediate", plot =="Partial", block == 2) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(IntermediateP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate PARTIAL BLOCK 2 = 2

IntermediateP <- mamcounts %>%
  filter(site == "Intermediate", plot =="Partial", block == 3) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(IntermediateP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate PARTIAL BLOCK 1= estimates were in 700 so omitted this data

##########################################################################

IntermediateT <- mamcounts %>%
  filter(site == "Intermediate", plot =="Total", block == 1) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(IntermediateT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] 

## Intermediate TOTAL BLOCK 1= 	31.33333

IntermediateT <- mamcounts %>%
  filter(site == "Intermediate", plot =="Total", block == 2) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(IntermediateT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] 

## Intermediate TOTAL BLOCK 2= 	estimates over 5 mil so omitted

IntermediateT <- mamcounts %>%
  filter(site == "Intermediate", plot =="Total", block == 3) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(IntermediateT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] 
## Intermediate TOTAL BLOCK 1= 	2


#############################################################################
# MESIC
#############################################################################
#############################################################################

MesicO <- mamcounts %>%
  filter(site == "Mesic", plot =="Open", block == 1) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(MesicO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Mesic OPEN BLOCK 1= 28.5

MesicO <- mamcounts %>%
  filter(site == "Mesic", plot =="Open", block == 2) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(MesicO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Mesic OPEN BLOCK 2= 2

MesicO <- mamcounts %>%
  filter(site == "Mesic", plot =="Open", block == 3) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(MesicO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Mesic OPEN BLOCK3 = 12.0847


##########################################################################
MesicP <- mamcounts %>%
  filter(site == "Mesic", plot =="Partial", block == 1) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(MesicP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

# MESIC PARTIAL BLOCK1 = 215.727

MesicP <- mamcounts %>%
  filter(site == "Mesic", plot =="Partial", block == 2) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(MesicP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

# MESIC PARTIAL BLOCK 2= 15.51451

MesicP <- mamcounts %>%
  filter(site == "Mesic", plot =="Partial", block == 3) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(MesicP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

# MESIC PARTIAL BLOCK = estimates were 10mil so omitted them

##########################################################################

MesicT <- mamcounts %>%
  filter(site == "Mesic", plot =="Total", block == 1) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(MesicT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance # second best fit model is M0, since 1st best fit is -10 with Mb

## Mesic TOTAL BLOCK 1 = 62.26667

MesicT <- mamcounts %>%
  filter(site == "Mesic", plot =="Total", block == 2) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(MesicT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance # second best fit model is M0, since 1st best fit is -10 with Mb

## Mesic TOTAL BLOCK 2 = 7.854102

MesicT <- mamcounts %>%
  filter(site == "Mesic", plot =="Total", block == 3) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(MesicT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance # second best fit model is M0, since 1st best fit is -10 with Mb

## Mesic TOTAL BLOCK 1 = 17.20092

```

#### Mammal metrics of Shannon richness and species diversity

*Original datasets I was given: `2018_smammals` and `Small_mammal_captures_19`* 

From those, I created excel sheets called `tejon_mammals1819_09022020` and `tejon_mammalcount_09032020`.
```{r warning=FALSE}
# full dataset
mammals <- read_csv("tejon_mammals1819_09022020.csv")
# subset for important
mammal <-data.frame(mammals[,4:6],mammals[,9])


# numeric dataframe for community analysis
Count <- read_csv("tejon_mammalcount_09032020.csv")

# remove the arid with NAs, this will be the full dataset with species richenss and diversity added
count <- Count[-4,]
# keep only numeric data to run community analyses
numeric <- count[,c(-1,-2,-9,-10)]
# organize data into right forms
count$plot <- factor(count$plot, 
                        levels = c('open','partial','total'))
# species richness
sppr <- specnumber(numeric)
# shannon diversity
shannondiv <- diversity(numeric)
# add species richness to count
count$sppr<-specnumber(numeric)
# add shannon diversity to count
count$shannondiv <- diversity(numeric)


```


---
title: "Tejon_Analysis_02162021"
author: "sbsambado"
date: "2/16/2021"
output: html_document
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readr)
library(ggpubr)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(plyr)
library(car)
library(multcomp)
library(multcompView)
library(reshape2)
library(stringr)
library(car)
library(psych)
library(knitr)
library(nlme)
library(lme4)
library(kableExtra)
library(MASS)
library(grid)
library(vegan)
library(devtools)
library(ggfortify)
library(jtools)
library(effects)
library(pscl)
library(lmtest)
library(ggstance)
library(huxtable)
library(qwraps2)
library(gtsummary)
library(Rcapture)
library(xlsx)
library(glmmTMB) 
library(tidyverse) 
library(gt) 
library(patchwork) 
library(effects) 
library(jtools)
devtools::install_github('gavinsimpson/ggvegan')


clean_background <- theme(plot.background = element_rect("white"),
        panel.background = element_rect("white"),
        panel.grid = element_line("white"),
        axis.line = element_line("gray25"),
        axis.text = element_text(size = 12, color = "gray25"),
        axis.title = element_text(color = "gray25"),
        legend.text = element_text(size = 12),
        legend.key = element_rect("white"))

plotcolor = c('darkseagreen1','darkseagreen3','darkseagreen4')
sitecolor = c('brown1','tan1','lightgoldenrod1')

rotatexaxistheme <- theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))
ytitletheme <- theme(axis.title.y = element_text(face = 'bold', size = 12, vjust = 0.5))
xtitletheme <- theme(axis.title.x = element_text(face = 'bold', size = 12, vjust = 0.5))
```

# Tick Means Analyses

### Dataset for tick mean analyses
Using data Steph sent on 11/16/2020
"Total_Ticks_2016_to_2018.csv"
"Tick_19.csv"
```{r message = FALSE}

threeyrs <- read_csv("Total_Ticks_2016_to_2018.csv")
dim(threeyrs)
oneyr <- read_csv("Tick_19.csv")
dim(oneyr)
# get rid of survery column in threeyr since it wasn't completed in oneyrs 
## Maybe double check survey number doesn't matter
threeyrs <- subset(threeyrs, select = -c(3))

# make sure names are the same
## 2016 - 2018
names(threeyrs) <- tolower(names(threeyrs))

# change column names
names(threeyrs)[6] <- "total"
names(threeyrs)[7] <- "deoc"
names(threeyrs)[8] <- "ipac"
names(threeyrs)[9] <- "deva"
names(threeyrs)[10] <- "other"

## 2019
# make sure names are the same
names(oneyr) <- tolower(names(oneyr))

# change column names
names(oneyr)[6] <- "total"
names(oneyr)[7] <- "deoc"
names(oneyr)[8] <- "ipac"
names(oneyr)[9] <- "deva"
names(oneyr)[10] <- "other"


tick <- rbind(threeyrs, oneyr)

# log transform data
tick$log_total <- log(tick$total + 1)

## FINAL DATASET TO COMPARE TICK MEANS
dim(tick) # 1449 11
str(tick)

tick$year <- as.numeric(tick$year)
tick$site <- as.factor(tick$site)
tick$plot <- as.factor(tick$plot)
Tick <- tick

# write to an excel sheet
#write.xlsx(Tick, file = "Tejon_MeanComparisons_Dataset.xlsx",
#          col.names = TRUE, row.names = TRUE)

```

Basic stats
```{r warning = FALSE}

(plotcount <- Tick %>% 
  group_by(plot) %>% 
  tally(total) )# open = 488, partial = 976, total = 1228

(sitecount <- Tick %>% 
  group_by(site) %>% 
  tally(total)) # arid = 340, intermediate = 1764, mesic = 588

(Tickcount <- Tick %>% 
  group_by(site, plot) %>% 
  tally(total))

(tickmodels <-kable(Tickcount, digits = 2, align = 'c') %>%
    pack_rows(
      index = c("Arid" = 3, "Intermediate" = 3, "Mesic" = 3)
    ))

Plot <- c('Open','Partial', 'Total',
          'Open','Partial', 'Total',
          'Open','Partial', 'Total')
n <- c('21', '195','124', '364', '554', '846', '103', '227', '258')

summm <- data.frame(Plot,n)

(suuuuuum <- kable(summm,digits = 2, align = 'c', booktabs = TRUE, caption = "Site") %>%
    pack_rows(
      index = c("Arid" = 3, "Intermediate" = 3, "Mesic" = 3)
    ) %>%
    kable_styling() %>%
  kable_paper() %>%
  save_kable(file = "table1.html", self_contained = T)
)
```

#### **1. Wilcox rank test for treatment vs control [medians total ticks]**
Plot (open vs total): W = 90379, p-value = 5.649e-07
```{r wilcox rank test}

site_subset <- Tick[which(Tick$site == "Arid" | Tick$site == "Mesic"),]
plot_subset <- Tick[which(Tick$plot == "Open" | Tick$plot == "Total"),]
leveneTest(site_subset$log_total ~ site_subset$site) # df 1, F value = 21.401, p = 4.263e-06, < 0.05, variances are different
leveneTest(plot_subset$log_total ~ plot_subset$plot) # df 1, F value = 34.118, p = 7.171e-09, < 0.05, variances are different


## wilcox (non-equal variances)

wilcox.test(log_total ~ site, data = site_subset) # W = 91628, p-value = 4.898e-05
wilcox.test(log_total ~ plot, data = plot_subset) # W = 90379, p-value = 5.649e-07
```
  
#### **2. TWO WAY ANOVA [log means of total ticks]**
Plot:
  + 3 levels, within-subjects factor?--> (F value = 20.298, df = 2, p= 2.05e-09)
  
Site:
  + 3 levels, within-subjects factor? --> (F value = 61.154, df = 2,  p < 2e-16)

Plot*Site interaction -->(F value = 0.847, df = 4, p = 0.496)

```{r two-way anova}
# log transform data
Tick$log_total <- log(Tick$total + 1)
# look at data
boxplot(log_total ~ site, data = Tick)
boxplot(log_total ~ plot, data = Tick)

# two way anova with log values and interaction value
aov_Tick <- aov(log_total ~ plot + site + (plot*site), data = Tick)
summary(aov_Tick)

# check assumptions on residuals
plot(aov_Tick) # both residual and qqPlot look normal

# check residuals
qqPlot(aov_Tick$residuals) # kinda looks normally distributed, but not perfect
shapiro.test(aov_Tick$residuals) # p < 0.05, data not normal but
dim(Tick) # 1449 CTL applies
```

#### **3. Post-hoc Test: Tukey Kramer**

**Site**
  Arid (a)
  Intermediate (b)
  Mesic (c )
**Plot**
  Open (a)
  Partial (b)
  Total (b)
  
```{r post-hoc test}
## Proceed with post-hoc test
TukeyHSD(aov_Tick)
# SITE
Post_hoc_site <-glht(aov_Tick, linfct = mcp(site = 'Tukey'))
summary(Post_hoc_site)

confint(Post_hoc_site) # pairwise test
cld(Post_hoc_site) # arid = a, intermediate = b, mesic = c
plot(Post_hoc_site) # plot 95% CIs

# PLOT
Post_hoc_plot <-glht(aov_Tick, linfct = mcp(plot = 'Tukey'))
summary(Post_hoc_plot)

confint(Post_hoc_plot) # pairwise test
cld(Post_hoc_plot) # open = a, partial = b, total = b
plot(Post_hoc_plot) # plot 95% CIs
```


# Tick Density Relationships

### Dataset for tick density relationships

Lots of movin' and groovin here. Trying to add multiple datasets together while avoiding duplication and too much observation lost
```{r building big dataset with individual datasets, message=FALSE}
##################################################################################################
# TICK COUNTS (YEAR, MONTH, PLOT, SITE)
#################################################################################################

# use cleaned up version that was used for mean tick count analyses = Tick
dim(Tick) # 1449 observations, 11 rows


##################################################################################################
# CLIMATE (TEMP, PRECIP)
#################################################################################################

############## temperature ##############
temp <- read_csv("Tejon_temperature_02022021.csv")
temp.tick <- merge(Tick, temp)
dim(temp.tick) # 1449, 14 (added meanmaxF, meanminF, station)
#View(temp.tick)

############## precipitation ##############

precip <- read_csv("tejon_tick_climate_10162020.csv")

precip_subset <- subset(precip, select = c(1:5,19,20))
names(precip_subset) <- tolower(names(precip_subset))
temp.tick.precip <- join(temp.tick, precip_subset)
dim(temp.tick.precip) #2025, 16 (added precip (in), precip (mm))
names(temp.tick.precip)
# seems like data got duplicated let's fix that

# best way is to remove duplicate rows which I lose ~50 observations but I think that is a better way to do it then extract unique elements by columns since alot of these observations are repetitive

temp.tick.prep.short <- temp.tick.precip %>%
  distinct()

dim(temp.tick.prep.short) # 1395, 16

##################################################################################################
# VERTEBRATE (SPIECES RICHNESS, DIVERSITY, POP ESTIMATES)
#################################################################################################

############## mammal metrics ############## 

mam <- read_csv("tejon_mammal_02022021.csv")
names(mam) <- tolower(names(mam))

climate.mam <- join(temp.tick.prep.short, mam)
dim(climate.mam) # 1895, 19 (added cum_mammal, shan_mammal, rich_mammal)

# remove duplicate rows

climate.mam.short <- climate.mam %>%
  distinct()
dim(climate.mam.short) #1395, 19 # same amount of observations after climate dataset


############## pop estimates ############## 

pop_estimates <-read_csv("tejon_mamliz_popestimates.csv")
dim(pop_estimates) #27 5

climate.mam.combo <- join(climate.mam.short, pop_estimates)
dim(climate.mam.combo) # 1395   21 (added liz estimates, mam estimates)
names(climate.mam.combo)[20] <- "liz_estimates"

dim(climate.mam.combo) # 1395   21
names(climate.mam.combo)

```



```{r tidy final big data}
# let's shape this final sheet

## add some more metadata
# add Celcius
climate.mam.combo$mean_maxC <- (climate.mam.combo$mean_maxF - 32)*(5/9)
climate.mam.combo$mean_minC <- (climate.mam.combo$mean_minF - 32)*(5/9)


# add temperature difference 
climate.mam.combo$tempdifF <- (climate.mam.combo$mean_maxF - climate.mam.combo$mean_minF)
climate.mam.combo$tempdifC <- (climate.mam.combo$mean_maxC - climate.mam.combo$mean_minC)



# add elevation
  climate.mam.combo$elevation <- climate.mam.combo$station
  climate.mam.combo$elevation[climate.mam.combo$station == "Lebec"] <- 1089.7
  climate.mam.combo$elevation[climate.mam.combo$station == "Loraine"] <- 1290.8
  climate.mam.combo$elevation[climate.mam.combo$station == "Chuchupate"] <- 1493.5

# add rain year
  # this is a dumb way but it is what it is
  climate.mam.combo$rain_year <- as.numeric(climate.mam.combo$year)
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'April'] <- "2015/2016"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'May'] <- "2015/2016"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'June'] <- "2015/2016"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'July'] <- "2015/2016"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'August'] <- "2015/2016"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'September'] <- "2015/2016"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'October'] <- "2015/2016"
  
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'November'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2016 & climate.mam.combo$month == 'December'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'January'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'February'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'March'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'April'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'May'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'June'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'July'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'August'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'September'] <- "2016/2017"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'October'] <- "2016/2017"
  
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'November'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2017 & climate.mam.combo$month == 'December'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'January'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'February'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'March'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'April'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'May'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'June'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'July'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'August'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'September'] <- "2017/2018"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'October'] <- "2017/2018"
  
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'November'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2018 & climate.mam.combo$month == 'December'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'January'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'February'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'March'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'April'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'May'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'June'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'July'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'August'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'September'] <- "2018/2019"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'October'] <- "2018/2019"
  
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'November'] <- "2019/2020"
  climate.mam.combo$rain_year[climate.mam.combo$year == 2019 & climate.mam.combo$month == 'December'] <- "2019/2020"

# add plotID
climate.mam.combo <- transform(climate.mam.combo, plotidname = as.character(interaction(site, plot,block, drop = TRUE)))
climate.mam.combo <- transform(climate.mam.combo, plotID = as.numeric(interaction(site, plot,block, drop = TRUE)))
#str(climate.mam.combo) # 1395 observations, 26 variables (added plotidname, plotID)

# put data in right format
#str(climate.mam.combo)

climate.mam.combo$year <- as.factor(climate.mam.combo$year)
climate.mam.combo$block <- as.factor(climate.mam.combo$block)
climate.mam.combo$plotID <- as.factor(climate.mam.combo$plotID)
climate.mam.combo$rain_year <- as.factor(climate.mam.combo$rain_year)
climate.mam.combo$elevation <- as.numeric(climate.mam.combo$elevation)

climate.mam.combo$month <- factor(climate.mam.combo$month, 
                        levels = c('January', 'February', 'March',
                                   'April', 'May', 'June', 'July',
                                   'August', 'September', 'October',
                                   'November', 'December'))
climate.mam.combo$site <- factor(climate.mam.combo$site, 
                    levels = c('Arid', 'Intermediate', 'Mesic'))

climate.mam.combo$plot <- factor(climate.mam.combo$plot, 
                    levels = c('Open', 'Partial', 'Total'))

# rename precip columns
names(climate.mam.combo)[15] <- "precip_in"
names(climate.mam.combo)[16] <- "precip_mm"


# Finally, the final dataset for GLMMS
FINAL <- climate.mam.combo
#str(FINAL) # 1395 observations, 29 variables

# write to an excel sheet
#write.xlsx(FINAL, file = "Tejon_MixedModels_Dataset.xlsx",
#           col.names = TRUE, row.names = TRUE)
```



#### **4.Correlation using Spearman's rank**
Used non-parametric Spearman's rank correlation. Looking at an association between the rank of tick counts and a potential predictor variables.

tick counts ~ potential predictors

+ lizard population estimates
+ temperature difference (C)
+ monthly precipitation (mm)
+ mammal population estimates
+ mean max temperature (C)

```{r correlation}
#cor.final <- subset(FINAL, select = c(11,20,21, 30)) # choosing variables of interest
#pairs.panels(cor.final)  # chose the variables that make the most sense for cor.test     

cor.test(FINAL$total, FINAL$liz_estimate, method = "spearman", alternative = "two.sided")             # rho = .2187888  # p-value = 3.496e-11   

cor.test(FINAL$total, FINAL$tempdifC, method = "spearman", alternative = "two.sided")             
# rho = 0.1168557 # p-value = 4.643e-05

cor.test(FINAL$total, FINAL$precip_mm, method = "spearman", alternative = "two.sided")             
# rho = - 0.05

cor.test(FINAL$total, FINAL$mam_estimates, method = "spearman", alternative = "two.sided")            # rho = .0240  

cor.test(FINAL$total, FINAL$mean_maxC, method = "spearman", alternative = "two.sided")             
# rho = 0.02388285 


cor.test(FINAL$total, FINAL$shan_mammal, method = "spearman", alternative = "two.sided")             # rho = - 0.019

cor.test(FINAL$total, FINAL$mean_minC, method = "spearman", alternative = "two.sided")             
# rho = - .0299





```

#### **5.Generalized linear models (GLMs)**
tick counts ~ treatment

What happens if we just look at one treatment type?
+ Treatment 1: site as a proxy for climate
+ Treatment 2: plot as a proxy for host structure

*Site is a better predictor**
 Intercept = -0.26754
 siteIntermediate estimate = 1.58575, p-value = < 0.0000000000000002
 siteMesic estimate = 0.50949, p-value = 0.000000000000193
 Null deviance: 7844.1  on 1349  degrees of freedom
 Residual deviance: 6717.4  on 1347  degrees of freedom
 AIC: 8320.7

```{r glm, warning = FALSE}
boxplot(total ~ site, data = FINAL)
boxplot(total ~ plot, data = FINAL)

tab <- xtabs(~log_total, data = FINAL)
x <- as.numeric(names(tab))
plot(x, tab, type = "h")
points(x, tab, pch = 16)

mod.counts <- glm(total ~ site + plot,
                  family = poisson, data = FINAL)
summary(mod.counts)

plot(predictorEffects(mod.counts))

# look at summary analyses
glm.site = glm(total ~ site, data = FINAL, family = "poisson")
summary(glm.site) 
# Intercept = -0.26754
# siteIntermediate estimate = 1.58575, p-value = < 0.0000000000000002
# siteMesic estimate = 0.50949, p-value = 0.000000000000193
# Null deviance: 7844.1  on 1349  degrees of freedom
# Residual deviance: 6717.4  on 1347  degrees of freedom
# AIC: 8320.7

glm.plot = glm(total ~ plot, data = FINAL, family = "poisson")
summary(glm.plot)
# Intercept = 0.08338
# plotPartial estimate = 0.66613, p-value = <0.0000000000000002
# plotTotal estimate = 0.90155, p-value = <0.0000000000000002
# Null deviance: 7844.1  on 1349  degrees of freedom
# Residual deviance: 7528.3  on 1347  degrees of freedom
# AIC: 9131.6
```





#### **6.Negative binomial generalized linear mixed-models (NB GLMMs)
```{r general structure, warnings =FALSE, message=FALSE}
final.plot <- subset(FINAL, select = c(11:21))
pairs.panels(final.plot) # makes sense that min-max, cum-shan, cum-rich are highly correlated, keep this in mind when building models

## random effects models

# tick counts ~ climate + host, random = ~1|plotID + ~1|rain year
```

##### **6A. Climate models**
*Best model*
gnb_mod3 <- glmer.nb(total ~ tempdifC + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")
```{r climate models, warnings =FALSE, message=FALSE}
######################## CLIMATE MODELS ########################
###### mean_maxF, mean_minF, tempdifF, mean_maxC, mean_minC, tempdifC, precip_in, precip_mm ####


#str(FINAL)
climate_gnb_mod1 <- glmer.nb(total ~  mean_maxC + (1|plotID) + (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")


climate_gnb_mod2 <- glmer.nb(total ~ mean_minC + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

climate_gnb_mod3 <- glmer.nb(total ~ tempdifC + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

climate_gnb_mod4 <- glmer.nb(total ~ precip_mm + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

climate_gnb_mod5 <- glmer.nb(total ~ mean_maxC + mean_minC + tempdifC +precip_mm + 
                       (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")


climate_result <- AIC(climate_gnb_mod1, climate_gnb_mod2, climate_gnb_mod3,climate_gnb_mod4,climate_gnb_mod5)
climate_models <- list(climate_gnb_mod1, climate_gnb_mod2, climate_gnb_mod3,climate_gnb_mod4,climate_gnb_mod5)



climate_result$BIC <- sapply(climate_models, BIC)
climate_model_summary <- lapply(climate_models, summary)
for(i in 1:(length(climate_models)-1)){ #this creates a variable i that starts with the value i=1
  climate_result$rsq[i] <- climate_model_summary[[i]]$r.squared #we assign the rsq value from model i to the i'th row of the column 'rsq' in the table 'results'
  climate_result$adj_rsq[i] <- climate_model_summary[[i]]$adj.r.squared #same for adjusted rsq
} #now we go back to the beginning of the for-loop, add 1 to the value of i, and do everything again

climate_result$variables <- c("maxC", "minC", "tempdiffC", "precip_mm", "Full")

climate_models <- kable(climate_result, digits = 2, align = "c") %>%
  kable_styling()

### best fit model is gnb.mod3...difference in C based on BIC


```


##### **6B.Host models**
*Best model*
gnb_mod4 <- glmer.nb(total ~ liz_estimate + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")
```{r host models, warnings =FALSE, message=FALSE}
######################## HOST MODELS ########################
###### cum_mammal shan_mammal rich_mammal liz_estimates mam_estimates ####


#str(FINAL)


host_gnb_mod1 <- glmer.nb(total ~ shan_mammal + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

host_gnb_mod2 <- glmer.nb(total ~ liz_estimates + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

host_gnb_mod3 <- glmer.nb(total ~ mam_estimates + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

# there's collinearity in full
host_gnb_mod4 <- glmer.nb(total ~ shan_mammal + liz_estimates + mam_estimates + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

# less collinearity in partial
#host_gnb_mod7 <- glmer.nb(total ~ cum_mammal + shan_mammal + rich_mammal + liz_estimatess + mam_estimates + (1|plotID)+ (1|rain_year) + (1|month), data = na.omit(FINAL),family = "poisson")

host_result <- AIC(host_gnb_mod1, host_gnb_mod2, host_gnb_mod3,host_gnb_mod4)
host_models <- list(host_gnb_mod1, host_gnb_mod2, host_gnb_mod3,host_gnb_mod4)



host_result$BIC <- sapply(host_models, BIC)
host_model_summary <- lapply(host_models, summary)
for(i in 1:(length(host_models)-1)){ #this creates a variable i that starts with the value i=1
  host_result$rsq[i] <- host_model_summary[[i]]$r.squared #we assign the rsq value from model i to the i'th row of the column 'rsq' in the table 'results'
  host_result$adj_rsq[i] <- host_model_summary[[i]]$adj.r.squared #same for adjusted rsq
} #now we go back to the beginning of the for-loop, add 1 to the value of i, and do everything again

host_result$variables <- c("shan_mam","liz_estimatess", "mam_estimates", "Full")

host_models <- kable(host_result, digits = 2, align = "c") %>%
  kable_styling()


```

##### **6C.Combination models**
*Best fit*
BIC = 907.06
gnb_mod5 <- glmer.nb(total ~ tempdifC*site + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")
BIC = 908.18                
gnb_mod3 <- glmer.nb(total ~ tempdifC + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

```{r combo models, warnings =FALSE, message=FALSE}

# plot predictor
combo_gnb_mod1 <- glmer.nb(total ~ plot + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

# site predictor
combo_gnb_mod2 <- glmer.nb(total ~ site + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

# best climate predictor
combo_gnb_mod3 <- glmer.nb(total ~ tempdifC + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")
# best host predictor
combo_gnb_mod4 <- glmer.nb(total ~ liz_estimates + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

# interaction models
combo_gnb_mod5 <- glmer.nb(total ~ tempdifC*site + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

combo_gnb_mod6 <- glmer.nb(total ~ liz_estimates*plot + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")


# full
combo_gnb_mod7 <- glmer.nb(total ~ plot + site + tempdifC + liz_estimates + tempdifC*site + liz_estimates*plot + (1|plotID)+ (1|rain_year) + (1|month), 
                 data = na.omit(FINAL),
                 family = "poisson")

combo_result <- AIC(combo_gnb_mod1, combo_gnb_mod2, combo_gnb_mod3,combo_gnb_mod4,combo_gnb_mod5,combo_gnb_mod6,combo_gnb_mod7)
combo_models <- list(combo_gnb_mod1, combo_gnb_mod2, combo_gnb_mod3,combo_gnb_mod4,combo_gnb_mod5,combo_gnb_mod6,combo_gnb_mod7)



combo_result$BIC <- sapply(combo_models, BIC)
combo_model_summary <- lapply(combo_models, summary)
for(i in 1:(length(combo_models)-1)){ #this creates a variable i that starts with the value i=1
  combo_result$rsq[i] <- combo_model_summary[[i]]$r.squared #we assign the rsq value from model i to the i'th row of the column 'rsq' in the table 'results'
  combo_result$adj_rsq[i] <- combo_model_summary[[i]]$adj.r.squared #same for adjusted rsq
} #now we go back to the beginning of the for-loop, add 1 to the value of i, and do everything again

combo_result$variables <- c("plot", "site", "tempdifC", "liz_estimates", "tempdifC*site", "liz_estimates*plot", "Full")

combo_models <- kable(combo_result, digits = 2, align = "c") %>%
  kable_styling()


## best fit model is interaction1 (liz estimates*plot) BIC = 907.06
## next best one is temp BIC = 908.18
```

#### **7. Model comparisons**

Tables of model summaries
```{r kables, results = "asis"}
## kables
climate_models
host_models
combo_models
```

```{r summ package full models, results = "asis"}
## summ package https://cran.r-project.org/web/packages/jtools/vignettes/summ.html#Generalized_and_Mixed_models
library(sandwich)
library(officer)
library(flextable)

### effect plots
  # best host
  effect_plot(host_gnb_mod2, pred = liz_estimates, interval = FALSE, plot.points = FALSE)
  # best climate
  effect_plot(climate_gnb_mod3, pred = tempdifC, interval = FALSE, plot.points = FALSE)

### plot summs
  plot_summs(host_gnb_mod4, climate_gnb_mod5, combo_gnb_mod7,scale = TRUE,
             model.names = c("Host", "Climate", "Combination"))
  

### export summs
  ## climate
  export_summs(climate_gnb_mod1,climate_gnb_mod2,climate_gnb_mod3,climate_gnb_mod4,climate_gnb_mod5, 
               confint = TRUE,exp = TRUE,digits = 4,
               error_format = "({statistic}, p = {p.value})", 
               to.file = "docx", file.name = "Tejon_FULLClimateModels.docx") # could set to PDF and .pdf
  ## host
  
  
  export_summs(host_gnb_mod1,host_gnb_mod2,host_gnb_mod3,host_gnb_mod4, 
               confint = TRUE,exp = TRUE,digits = 4,
               error_format = "({statistic}, p = {p.value})",
               to.file = "docx", 
               file.name = "Tejon_FULLHostModels.docx")
  
  ## combo
  
  export_summs(combo_gnb_mod1,combo_gnb_mod2,combo_gnb_mod3,combo_gnb_mod4,combo_gnb_mod5,combo_gnb_mod6,combo_gnb_mod7,
               confint = TRUE, exp = TRUE, digits = 4,
               error_format = "({statistic}, p = {p.value})",
               to.file = "docx", 
               file.name = "Tejon_FULLComboModels.docx")
  
```

```{r summs package best models, results = "asis"}
# good standard for summ()
# summ(climate_gnbmod1, confint = TRUE,exp = TRUE, vifs = TRUE)

# best fit models within each group
summ(climate_gnb_mod3, exp = TRUE, confint = TRUE) # climate
summ(host_gnb_mod2, exp = TRUE, confint = TRUE) # host
summ(combo_gnb_mod5, exp = TRUE, confint = TRUE) # combo


# export best fit models within each group
export_summs(climate_gnb_mod3,host_gnb_mod2,combo_gnb_mod5,
              confint = TRUE,exp = TRUE,digits = 3,
               error_format = "({statistic}, 95% CI [{conf.low}, {conf.high}], p = {p.value})", 
               to.file = "docx", file.name = "Tejon_BestFitModels.docx")
```

##### **7A. Summary of best fit model
```{r}
summary(combo_gnb_mod5)

effect_plot(combo_gnb_mod5, pred = tempdifC, interval = FALSE, plot.points = FALSE)


```

Check model assumption
https://stats.idre.ucla.edu/r/dae/negative-binomial-regression/

```{r}

# check residuals
# plot(combo_gnb_mod3)
# 
# # best model based on parsimony is 
# m1 <- glmer.nb(total ~ tempdifC + (1|plotID)+ (1|rain_year) + (1|month), 
#                  data = na.omit(FINAL),
#                  family = "poisson")
# # Neg binomial models assume the conditional means are not equal to the conditional variances. This inequality is captured by estimating a dispersion parater that is held constant in a poisson model. The poisson model is actually nested int he negative binomial mode. We can use likelihood ratio test to compare thes two and test the model assumption
# 
# # compare model without tempdifC to see if it is significantly different
# m2 <- update(combo_gnb_mod3, . ~ . - tempdifC)
# anova(m1, m2) # 2.716e-05, tempdiffC is a singificant predictor of total 
# 
# # check model assumptions
# m3 <- glm(total ~ tempdifC + site, family = "poisson", data = FINAL)
# pchisq(2 * (logLik(m1) - logLik(m3)), df = 1, lower.tail = FALSE)
# 
# (est <- cbind(Estimate = coef(m1), confint(m1)))
# exp(est)
```

Predicted values
```{r}

## see if it can predict model
splitter <- sample(1:nrow(FINAL), 70, replace = F)
final_train <- na.omit(FINAL[-splitter,])
final_test <- na.omit(FINAL[splitter,])

final_fit <- glmer.nb(total ~ tempdifC + (1|plotID)+ (1|rain_year) + (1|month),
                 data = na.omit(FINAL),
                 family = "poisson")

prediction <- predict(final_fit, final_test)

plot(final_test$total, pch = 1)
points(prediction, pch = 20, col = "red")

```


#### **7B. Other model validation**

**1. The best(top) model state that liz_estimatess and tempdifC are important**
```{r}

min(FINAL$total)
model <- na.omit(FINAL)
big.model <- glm(total  ~ plot + site  + tempdifC + liz_estimates, 
                 family = "poisson",
                 data = model,
                 na.action = na.pass)
library(MuMIn)
library(gtable)
sal.dredge <- dredge(big.model)

glm.best <-model.sel(sal.dredge) %>% 
  gt() %>% 
  tab_header(title="all model subsets",
             subtitle = "total ~ plot + site + tempdifC + liz_estimatess")
gtsave(glm.best, "DredgeModel_BestPredictors.html")

```

**2. Relative support for each model using Akaike weight**
Basically, we are comparing a set of models and want to know the probability that a model is the best model in the set. To get an Akaike weight, we can standardize the likelihood of the model:
$$
w_i = \frac{exp(-\frac{1}{2}\Delta_i)}{\Sigma^R_jexp(-\frac{1}{2}\Delta_i)}
$$
where $R$ is the number of models in the set, and $w_i$ is the probability that the model $i$ is the best model. 

If we calculate $\Delta_i$ and $w_i$, we can compare the models.

```{r}
# calculate deltai2
delta1 <- exp(-0.5*(AIC(combo_gnb_mod1) - AIC(combo_gnb_mod5)))
delta2 <- exp(-0.5*(AIC(combo_gnb_mod2) - AIC(combo_gnb_mod5)))
delta3 <- exp(-0.5*(AIC(combo_gnb_mod3) - AIC(combo_gnb_mod5)))
delta4 <- exp(-0.5*(AIC(combo_gnb_mod4) - AIC(combo_gnb_mod5)))
delta5 <- exp(-0.5*(AIC(combo_gnb_mod5) - AIC(combo_gnb_mod5)))

# sum likelihoods
sum_likes <- sum(c(delta1, delta2, delta3, delta4, delta5))

# calculate weights
weight1 <- delta1/sum_likes
weight2 <- delta2/sum_likes
weight3 <- delta3/sum_likes
weight4 <- delta4/sum_likes
weight5 <- delta5/sum_likes

# lets make a table
weights <- tribble(
  ~Model,   ~Delta,           ~Weights,   ~Variable,
  "combo_gnb_mod1", round(delta1, 2), round(weight1, 2), "plot",
  "combo_gnb_mod2", round(delta2, 2), round(weight2, 2), "site",
  "combo_gnb_mod3", round(delta3, 2), round(weight3, 2), "tempdiffC",
  "combo_gnb_mod4", round(delta4, 2), round(weight4, 2), "liz estimates",
  "combo_gnb_mod5", round(delta5, 2), round(weight5, 2), "tempdiffC*site"
) %>% 
  gt() %>% 
  tab_style(
    style = cell_text(size = "small"),
    locations = cells_body())

weights

# combo_gnb_mod5 has a 99% chance of being the best model
```

### **8. Additional Analyses that were used to make input variables for glmms

#### **8A. Population estimates for lizards and mammals

*Original datasets I was given: `Lizard_Counts_TREE` for lizards and `2018_smammals` and `Small_mammal_captures_19`* 

From those, I created an excel sheet called `tejon_mamliz_popestimates` that I made based on the analyses in lizard estimates and mammal estimates. Yes, I know this could have been done with a for loop but couldn't get my brain to think about it. This excel sheet is used to build the full data sheet with climate and tick counts

```{r data sheets for pop estimates}
# Used these data sheets to calculate pop estimates. All calculations used to make population estimates can be found in the dataset `tejon_mamliz_popestimates`.
### mammals 
mamcounts <- read_csv("mammal_counts_02182021.csv")
dim(mamcounts) # 229   9

#str(mamcounts)
mamcounts$day1 <- as.numeric(mamcounts$day1)
mamcounts$day2 <- as.numeric(mamcounts$day2)
mamcounts$day3 <- as.numeric(mamcounts$day3)
mamcounts$site <- as.factor(mamcounts$site)
mamcounts$plot <- as.factor(mamcounts$plot)
mamcounts$block <- as.numeric(mamcounts$block)
#str(mamcounts)

### lizards
lizcounts <- read_csv("lizardcounts_02172021.csv")
dim(lizcounts) # 1745 , 10
names(lizcounts) <- tolower(names(lizcounts))

#str(lizcounts)
lizcounts$day1 <- as.numeric(lizcounts$day1)
lizcounts$day2 <- as.numeric(lizcounts$day2)
lizcounts$day3 <- as.numeric(lizcounts$day3)
lizcounts$site <- as.factor(lizcounts$site)
lizcounts$plot <- as.factor(lizcounts$plot)
lizcounts$block <- as.numeric(lizcounts$block)
#str(lizcounts)

```

```{r lizard estimates}
AridO <- lizcounts %>%
  filter(site == "Arid", plot =="Open", block == 1) %>%
  select(day1, day2, day3)
  
abundance0 = closedp.t(AridO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundance0$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

# ARID OPEN BLOCK 1 = 51.35882

AridO <- lizcounts %>%
  filter(site == "Arid", plot =="Open", block == 2) %>%
  select(day1, day2, day3)
  
abundance0 = closedp.t(AridO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundance0$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

# ARID OPEN BLOCK 2 = 60.5687

AridO <- lizcounts %>%
  filter(site == "Arid", plot =="Open", block == 3) %>%
  select(day1, day2, day3)
  
abundance0 = closedp.t(AridO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundance0$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

# ARID OPEN BLOCK 3 = 82.54301



##########################################################################
AridP <- lizcounts %>%
  filter(site == "Arid", plot =="Partial", block == 1) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(AridP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID PARTIAL Block 1 = 73.4186

AridP <- lizcounts %>%
  filter(site == "Arid", plot =="Partial", block == 2) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(AridP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID PARTIAL Block 2 = 72.96941

AridP <- lizcounts %>%
  filter(site == "Arid", plot =="Partial", block == 3) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(AridP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID PARTIAL Block 3 = 69.2156


##########################################################################

AridT <- lizcounts %>%
  filter(site == "Arid", plot =="Total", block == 1) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(AridT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID TOTALBLOCK 1 = 67.28581

AridT <- lizcounts %>%
  filter(site == "Arid", plot =="Total", block == 2) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(AridT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID TOTALBLOCK 2 = 60.0097

AridT <- lizcounts %>%
  filter(site == "Arid", plot =="Total", block == 3) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(AridT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID TOTALBLOCK 3 = 88.44651


##############################################################################
##############################################################################
##############################################################################


IntermediateO <- lizcounts %>%
  filter(site == "Intermediate", plot =="Open", block == 1) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(IntermediateO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate OPEN BlOCK 1 = 129.3622

IntermediateO <- lizcounts %>%
  filter(site == "Intermediate", plot =="Open", block == 2) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(IntermediateO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate OPEN BlOCK 2 = 84.6362

IntermediateO <- lizcounts %>%
  filter(site == "Intermediate", plot =="Open", block == 3) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(IntermediateO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate OPEN BlOCK 3 = 207.9784

##########################################################################
IntermediateP <- lizcounts %>%
  filter(site == "Intermediate", plot =="Partial", block == 1) %>%
  select(day1, day2, day3) %>%
  na.omit(lizardcounts)
  
abundanceP = closedp.t(IntermediateP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate PARTIAL BLOCK 1 = 133.5039

IntermediateP <- lizcounts %>%
  filter(site == "Intermediate", plot =="Partial", block == 2) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(IntermediateP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate PARTIAL BLOCK 2 = 47.43047

IntermediateP <- lizcounts %>%
  filter(site == "Intermediate", plot =="Partial", block == 3) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(IntermediateP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate PARTIAL BLOCK 3 = 162.613

##########################################################################

IntermediateT <- lizcounts %>%
  filter(site == "Intermediate", plot =="Total", block == 1) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(IntermediateT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance , lowest BIC had negative value with Mbh so I chose next best model Mb abundance = 137.9494

## Intermediate TOTAL BLOCK 1 = 398.0468

IntermediateT <- lizcounts %>%
  filter(site == "Intermediate", plot =="Total", block == 2) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(IntermediateT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate TOTAL BLOCK 2 = 84.5119

IntermediateT <- lizcounts %>%
  filter(site == "Intermediate", plot =="Total", block == 3) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(IntermediateT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate TOTAL BLOCK 3 = 176.55


```

```{r mammal estimates }
AridO <- mamcounts %>%
  filter(site == "Arid", plot =="Open", block == 1) %>%
  select(day1, day2, day3)
  
abundance0 = closedp.t(AridO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundance0$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID OPEN Block 1 = 2

AridO <- mamcounts %>%
  filter(site == "Arid", plot =="Open", block == 2) %>%
  select(day1, day2, day3)
  
abundance0 = closedp.t(AridO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundance0$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID OPEN Block 2 = 5.236068

AridO <- mamcounts %>%
  filter(site == "Arid", plot =="Open", block == 3) %>%
  select(day1, day2, day3)
  
abundance0 = closedp.t(AridO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundance0$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID OPEN Block 3 = 2.618034

##########################################################################
AridP <- mamcounts %>%
  filter(site == "Arid", plot =="Partial", block == 1) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(AridP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID PARTIAL BLOCK 1= 15.51451
AridP <- mamcounts %>%
  filter(site == "Arid", plot =="Partial", block == 2) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(AridP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance , lowest BIC was negative so chose next lowest model M0

## ARID PARTIAL BLOCK 2= 45.38767
AridP <- mamcounts %>%
  filter(site == "Arid", plot =="Partial", block == 3) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(AridP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID PARTIAL BLOCK 3= estimates were in the 500000000 so I chose to omit this block 

##########################################################################

AridT <- mamcounts %>%
  filter(site == "Arid", plot =="Total", block == 1) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(AridT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID TOTAL block 1= 15.51451

AridT <- mamcounts %>%
  filter(site == "Arid", plot =="Total", block == 2) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(AridT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID TOTAL block 2= 40.80791

AridT <- mamcounts %>%
  filter(site == "Arid", plot =="Total", block == 3) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(AridT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## ARID TOTAL block 3= 15.51451


##############################################################################
##############################################################################
##############################################################################

# no mammals trapped at block 1 intermediate open

IntermediateO <- mamcounts %>%
  filter(site == "Intermediate", plot =="Open", block == 2) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(IntermediateO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate OPEN BLOCK 2 = 5.236068

IntermediateO <- mamcounts %>%
  filter(site == "Intermediate", plot =="Open", block == 3) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(IntermediateO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate OPEN BLOCK 3 = estimates were in the 7e09 so I chose to omit this block 


##########################################################################
IntermediateP <- mamcounts %>%
  filter(site == "Intermediate", plot =="Partial", block == 1) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(IntermediateP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate PARTIAL BLOCK 1= 7.734787

IntermediateP <- mamcounts %>%
  filter(site == "Intermediate", plot =="Partial", block == 2) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(IntermediateP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate PARTIAL BLOCK 2 = 2

IntermediateP <- mamcounts %>%
  filter(site == "Intermediate", plot =="Partial", block == 3) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(IntermediateP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Intermediate PARTIAL BLOCK 1= estimates were in 700 so omitted this data

##########################################################################

IntermediateT <- mamcounts %>%
  filter(site == "Intermediate", plot =="Total", block == 1) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(IntermediateT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] 

## Intermediate TOTAL BLOCK 1= 	31.33333

IntermediateT <- mamcounts %>%
  filter(site == "Intermediate", plot =="Total", block == 2) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(IntermediateT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] 

## Intermediate TOTAL BLOCK 2= 	estimates over 5 mil so omitted

IntermediateT <- mamcounts %>%
  filter(site == "Intermediate", plot =="Total", block == 3) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(IntermediateT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] 
## Intermediate TOTAL BLOCK 1= 	2


#############################################################################
# MESIC
#############################################################################
#############################################################################

MesicO <- mamcounts %>%
  filter(site == "Mesic", plot =="Open", block == 1) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(MesicO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Mesic OPEN BLOCK 1= 28.5

MesicO <- mamcounts %>%
  filter(site == "Mesic", plot =="Open", block == 2) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(MesicO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Mesic OPEN BLOCK 2= 2

MesicO <- mamcounts %>%
  filter(site == "Mesic", plot =="Open", block == 3) %>%
  select(day1, day2, day3)
  
abundanceO = closedp.t(MesicO, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceO$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

## Mesic OPEN BLOCK3 = 12.0847


##########################################################################
MesicP <- mamcounts %>%
  filter(site == "Mesic", plot =="Partial", block == 1) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(MesicP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

# MESIC PARTIAL BLOCK1 = 215.727

MesicP <- mamcounts %>%
  filter(site == "Mesic", plot =="Partial", block == 2) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(MesicP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

# MESIC PARTIAL BLOCK 2= 15.51451

MesicP <- mamcounts %>%
  filter(site == "Mesic", plot =="Partial", block == 3) %>%
  select(day1, day2, day3)
  
abundanceP = closedp.t(MesicP, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceP$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance 

# MESIC PARTIAL BLOCK = estimates were 10mil so omitted them

##########################################################################

MesicT <- mamcounts %>%
  filter(site == "Mesic", plot =="Total", block == 1) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(MesicT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance # second best fit model is M0, since 1st best fit is -10 with Mb

## Mesic TOTAL BLOCK 1 = 62.26667

MesicT <- mamcounts %>%
  filter(site == "Mesic", plot =="Total", block == 2) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(MesicT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance # second best fit model is M0, since 1st best fit is -10 with Mb

## Mesic TOTAL BLOCK 2 = 7.854102

MesicT <- mamcounts %>%
  filter(site == "Mesic", plot =="Total", block == 3) %>%
  select(day1, day2, day3)
  
abundanceT = closedp.t(MesicT, dfreq = FALSE, dtype="hist") 
models <- as.data.frame(abundanceT$results)
models <- models[order(models$BIC), ]

models[1,1] # select total abundance # second best fit model is M0, since 1st best fit is -10 with Mb

## Mesic TOTAL BLOCK 1 = 17.20092

```


##### **Kruskal-Wallis test: vertebrate populations across plot and sites**

**lizards only significantly different by site type (p-value = 0.09118, Kruskal-Wallis chi-squared = 6.7996)**
  + Arid
      + mean = 71
      + median = 70
      
  + Intermediate
      + mean = 130
      + median = 134

Could not do post-hoc test (wilcox, dunn, or conover) because I only have two groupings for site. Lizards were only sampled at arid and intermediate. I will calculate lizard medians and means as a way to show which site has more lizards post a significant kruskal wallis test.
  + **Intermediate has more lizards which also has higher tick counts**
  
```{r kruskal wallis}

# mammal populations did not significantly differ across sites or plots but that may be due to low sample numbers
kruskal.test(mam_estimates ~ plot, data = pop_estimates)
kruskal.test(mam_estimates ~ site, data = pop_estimates)

# lizard populations differed significantly by site type, but not plot
kruskal.test(liz_estimate ~ plot, data = pop_estimates)
kruskal.test(liz_estimate ~ site, data = pop_estimates)

# could not do post-hoc test (wilcox, dunn, or conover) because I only have two groupings for site. Lizards were only sampled at arid and intermediate. I will calculate lizard medians and means as a way to show which site has more lizards post a significant kruskal wallis test.

#str(pop_estimates)
pop_estimates$site <- as.factor(pop_estimates$site)
pop_estimates$plot <- as.factor(pop_estimates$plot)
kruskal.test(liz_estimate ~ site, data = pop_estimates) # p-value = 0.009118 , Kruskal-Wallis chi-squared = 6.7996

aggregate(mam_estimates ~ plot, data = pop_estimates, FUN = median) # O = 6, P = 16, T = 17
aggregate(mam_estimates ~ plot, data = pop_estimates, FUN = mean) # O = 8.71, P = 50.66, T = 24.50
aggregate(mam_estimates ~ site, data = pop_estimates, FUN = median) # A = 16, I = 6, M = 17
aggregate(mam_estimates ~ site, data = pop_estimates, FUN = mean) # A = 18.25, I = 10.0, M = 45.62

aggregate(liz_estimate ~ plot, data = pop_estimates, FUN = median) # O = 84.0, P = 73.5, T = 87.0	
aggregate(liz_estimate ~ plot, data = pop_estimates, FUN = mean) # O = 103.16667, P = 93.66667, T = 103.00


aggregate(liz_estimate ~ site, data = pop_estimates, FUN = median) # A = 70	, I = 134, M = NA
aggregate(liz_estimate ~ site, data = pop_estimates, FUN = mean) # A = 70.11, I = 129.77, M = NA
```


#### **8B. Mammal metrics of Shannon richness and species diversity

*Original datasets I was given: `2018_smammals` and `Small_mammal_captures_19`* 

From those, I created excel sheets called `tejon_mammals1819_09022020` and `tejon_mammalcount_09032020`.
```{r mammal metrics, warning=FALSE}
# full dataset
mammals <- read_csv("tejon_mammals1819_09022020.csv")
# subset for important
mammal <-data.frame(mammals[,4:6],mammals[,9])


# numeric dataframe for community analysis
Count <- read_csv("tejon_mammalcount_09032020.csv")

# remove the arid with NAs, this will be the full dataset with species richenss and diversity added
count <- Count[-4,]
# keep only numeric data to run community analyses
numeric <- count[,c(-1,-2,-9,-10)]
# organize data into right forms
count$plot <- factor(count$plot, 
                        levels = c('open','partial','total'))
# species richness
sppr <- specnumber(numeric)
# shannon diversity
shannondiv <- diversity(numeric)
# add species richness to count
count$sppr<-specnumber(numeric)
# add shannon diversity to count
count$shannondiv <- diversity(numeric)


```


#### **8C. Tick burdens compared to drags

Weak positive association between *drag ticks* and *burden ticks* (rho = 0.0229)
Slightly strong association between *burden ticks* and *lizard weight* (rho = 0.15197) and *lizard length* (rho = 0.166)

Very small tick burdens on mammals. There are 4 mammals with reported tick burdens. Max burden is 3 ticks. Intermediate had a sum of 7 burden ticks and Mesic had a sum of 1 burden ticks.
```{r message=FALSE}

burdens <- read_csv("lizardburdens_02172021.csv")
#str(burdens)
names(burdens) <- tolower(names(burdens))

burdens$block <- as.factor(burdens$block)
burdens$total.ticks <- as.numeric(burdens$total.ticks)

burdens$site <- factor(burdens$site, 
                    levels = c('Arid', 'Intermediate', 'Mesic'))

burdens$plot <- factor(burdens$plot, 
                    levels = c('Open', 'Partial', 'Total'))


ggplot(burdens, aes(x = plot, y = total.ticks))+
  geom_point()+
  geom_boxplot()+
  clean_background

aggregate(total.ticks ~ plot, data = burdens, FUN = mean)
aggregate(total.ticks ~ site, data = burdens, FUN = mean) # Intermediate highest mean 1.1129032, Mesic (1.00), Arid (0.545)
aggregate(total.ticks ~ site, data = burdens, FUN = sum) # Intermediate highest summed burdens (69), Arid(18), Mesic (2)


## format burdnes
burdens_sub <- subset(burdens, select = c(3:5, 18:19, 24))
names(burdens_sub)[6] <- "burden_ticks"
Tick_sub <- subset(Tick, select = c(3:6))
names(Tick_sub)[4] <- "quest_ticks"
burd <- merge(burdens_sub, Tick_sub)
#str(burd) #5205, 7
burd_nona <-na.omit(burd)
#str(burd_nona) #4578, 7

burd_nona$log_quest_ticks <- log(burd_nona$quest_ticks + 1)
burd_nona$log_burden_ticks <- log(burd_nona$burden_ticks + 1)

Burden <- burd_nona # cmon, make this an easier name
#str(Burden) # 4578, 9

cor.test(Burden$quest_ticks, Burden$burden_ticks, method = "spearman", alternative = "two.sided") # rho = 0.0229, very weak positive association 

cor.test(Burden$burden_ticks, Burden$`length(cm)`, method = "spearman", alternative = "two.sided") # rho = 0.166 slight positive association between burden and length

cor.test(Burden$burden_ticks, Burden$`weight(g)`, method = "spearman", alternative = "two.sided") # rho = 0.15197 slight positive association between burden and weight

#pairs.panels(Burden)



mam_burden <- subset(mammals, select = c(4:6, 13:14, 16))
#str(mam_burden) # 322, 6 

mam_burden_sub <-mam_burden %>%
  filter(ticks != "N") # lol, mammal burdens are so low, total of 8 tick burdnes across all of sampling (Interm sum = 7, Mesic sum = 1, max burden = 3)
```

